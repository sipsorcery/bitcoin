version: '{branch}.{build}'
skip_tags: true
image: Visual Studio 2019
configuration: Release
platform: x64
clone_depth: 5
environment:
  PATH: 'C:\Python37-x64;C:\Python37-x64\Scripts;%PATH%'
  PYTHONUTF8: 1
  QT_DOWNLOAD_URL: 'https://github.com/sipsorcery/qt_win_binary/releases/download/qt598x64_vs2019_v1681/qt598_x64_vs2019_1681.zip'
  QT_DOWNLOAD_HASH: '00cf7327818c07d74e0b1a4464ffe987c2728b00d49d4bf333065892af0515c3'
  QT_LOCAL_PATH: 'C:\Qt5.9.8_x64_static_vs2019'
  VCPKG_TAG: '2020.11-1'
#  VCPKG_NUGET_REPOSITORY: 'https://aaronrc.pkgs.visualstudio.com/bitcoin/_packaging/vcpkg-deps/nuget/v3/index.json'
#  VCPKG_BINARY_SOURCES: 'nuget,https://aaronrc.pkgs.visualstudio.com/bitcoin/_packaging/vcpkg-deps/nuget/v3/index.json,readwrite'
  VCPKG_BINARY_SOURCES: 'nuget,https://aaronrc.pkgs.visualstudio.com/bitcoin/_packaging/vcpkg-deps/nuget/v3/index.json,read'
#  VSS_NUGET_EXTERNAL_FEED_ENDPOINTS: 
#    secure: vcQ+C4CA8OTwWtyLHsFyaR6QOHdfXhuzclzEtKUgURTa4c9nP+nuB9DiMUz881r1KPVpdG31yGQ60qdP34v7l4ojBvQLX3EXbAubAwTYuvKe+vOqZ6yAcuYRdjyTdt4uhcb14vgdKBIEQJmY5OmlQwELYMbaj6RfQB8nrCl5tA2IqJtnGwLUUzIy6aMY6r3GAkWxcCFRZ8ECPy4nkqUFzsT82JQC+p/UZjyQzxA+4AGHLwufosP9++qS6QC4BrceBkJq9MOCvjP0omB9/HYZx7GYRfPPk6x1Vgx48MVgtW0=
install:
# Disable zmq test for now since python zmq library on Windows would cause Access violation sometimes.
# - cmd: pip install zmq
# Powershell block below is to install the c++ dependencies via vcpkg. The pseudo code is:
#    a. Checkout the vcpkg source (including port files) for the specific checkout and build the vcpkg binary,
#    b. Install the missing packages using the vcpkg manifest.
- ps: |
      Write-Host "VCPKG_TAG: $env:VCPKG_TAG."
      Write-Host "VCPKG_BINARY_SOURCES: $env:VCPKG_BINARY_SOURCES."
      Write-Host "VCPKG_NUGET_REPOSITORY: $env:VCPKG_NUGET_REPOSITORY."
      cd c:\tools\vcpkg
      $env:GIT_REDIRECT_STDERR = '2>&1' # git is writing non-errors to STDERR when doing git pull. Send to STDOUT instead.
      git pull origin master > $null
      git -c advice.detachedHead=false checkout $env:VCPKG_TAG
      .\bootstrap-vcpkg.bat
      Add-Content "C:\tools\vcpkg\triplets\$env:PLATFORM-windows-static.cmake" "set(VCPKG_BUILD_TYPE release)"
#      nuget setApiKey x -Source $env:VCPKG_NUGET_REPOSITORY
#      cd "$env:APPVEYOR_BUILD_FOLDER\build_msvc"
#      vcpkg install --triplet x64-windows-static --debug
      cd "$env:APPVEYOR_BUILD_FOLDER"
#      Exit-AppveyorBuild;
before_build:
# Powershell block below is to download and extract the Qt static libraries. The pseudo code is:
#    a. Download the zip file with the prebuilt Qt static libraries.
#    b. Check that the downloaded file matches the expected hash.
#    c. Extract the zip file to the specific destination path expected by the msbuild projects.
- ps: |
      Write-Host "Downloading Qt binaries.";
      Invoke-WebRequest -Uri $env:QT_DOWNLOAD_URL -Out qtdownload.zip;
      Write-Host "Qt binaries successfully downloaded, checking hash against $env:QT_DOWNLOAD_HASH...";
      if((Get-FileHash qtdownload.zip).Hash -eq $env:QT_DOWNLOAD_HASH) {
        Expand-Archive qtdownload.zip -DestinationPath $env:QT_LOCAL_PATH;
        Write-Host "Qt binary download matched the expected hash.";
      }
      else {
        Write-Host "ERROR: Qt binary download did not match the expected hash.";
        Exit-AppveyorBuild;
      }
- cmd: python build_msvc\msvc-autogen.py
build_script:
- cmd: msbuild /p:TrackFileAccess=false build_msvc\bitcoin.sln /m
after_build:
#- 7z a bitcoin-%APPVEYOR_BUILD_VERSION%.zip %APPVEYOR_BUILD_FOLDER%\build_msvc\%platform%\%configuration%\*.exe
test_script:
- cmd: src\test_bitcoin.exe -l test_suite
- cmd: src\bench_bitcoin.exe > NUL
- ps:  python test\util\bitcoin-util-test.py
- cmd: python test\util\rpcauth-test.py
# Fee estimation test failing on appveyor with: WinError 10048] Only one usage of each socket address (protocol/network address/port) is normally permitted.
# functional tests disabled for now. See
# https://github.com/bitcoin/bitcoin/pull/18626#issuecomment-613396202
# https://github.com/bitcoin/bitcoin/issues/18623
# - cmd: python test\functional\test_runner.py --ci --quiet --combinedlogslen=4000 --failfast --exclude feature_fee_estimation
artifacts:
#- path: bitcoin-%APPVEYOR_BUILD_VERSION%.zip
deploy: off
